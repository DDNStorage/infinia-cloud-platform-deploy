- name: Infinia Setup and Configuration
  hosts: all
  vars:
    ansible_connection: aws_ssm
    ansible_aws_ssm_bucket_name: red-ansible-scripts
    ansible_aws_ssm_region: us-east-1
    ansible_aws_ssm_timeout: 3600
  tasks:
    - name: Download Infinia Scripts
      shell: |
        wget https://storage.googleapis.com/ddn-redsetup-public/deployment-scripts/infinia-node-setup.sh -O /tmp/infinia-node-setup.sh
        wget https://storage.googleapis.com/ddn-redsetup-public/deployment-scripts/infinia-cluster-configure.sh -O /tmp/infinia-cluster-configure.sh
        chmod +x /tmp/infinia-node-setup.sh /tmp/infinia-cluster-configure.sh
      become: yes

    - name: Run Infinia Node Setup
      shell: |
        redsetup --reset >> /tmp/redsetup.log 2>&1 || true
        /tmp/infinia-node-setup.sh \
        --realm-entry \
        --version 1.3.36 \
        --realm-secret "PA-ssW00r^d" \
        --admin-password "PA-ssW00r^d" >> /tmp/redsetup.log 2>&1
      when: "'role_realm' in group_names"
      become: yes

    - name: Configure Non-Realm Node
      shell: |
        redsetup --reset >> /tmp/redsetup.log 2>&1 || true
        /tmp/infinia-node-setup.sh \
        --non-realm-entry \
        --ip {{ hostvars[groups['role_realm'][0]].private_ip_address }} \
        --version 1.3.36 \
        --realm-secret "PA-ssW00r^d" \ 
        --admin-password "PA-ssW00r^d" >> /tmp/redsetup.log 2>&1
      when: "'role_nonrealm' in group_names"
      become: yes

    - name: Copy the Infinia Cluster Configuration Script
      copy:
        src: ./infinia-cluster-configure.sh  # Path to your local script
        dest: /tmp/infinia-cluster-configure.sh
        mode: '0755'
      when: "'role_realm' in group_names"
      become: yes

    - name: Configure the Infinia Cluster
      shell: |
        /tmp/infinia-cluster-configure.sh \
        --admin-password "PA-ssW00r^d" \
        --license-key "1DE94FE1-BE7D-4A4B-8DA2-7761ED7B66EA"
      when: "'role_realm' in group_names"
      become: yes
